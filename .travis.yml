sudo: required

language: scala

scala:
  - 2.11.8

jdk:
  - oraclejdk8

env:
  global:
    - ENDPOINT=http://localhost:9911/
    - AWS_ACCESS_KEY_ID=foo
    - AWS_SECRET_ACCESS_KEY=bar

cache:
  bundler: true
  directories:
    - $HOME/.ivy2/cache
    - $HOME/.sbt/boot/

services:
  - docker

install:
  - sbt clean update
  - bundle install
  - docker run -d -p 9324:9324 s12v/elasticmq
  - docker run -it -v "$PWD":/tmp -w /tmp composer/composer:1-alpine install

script:
  - sbt coverage test
  - sbt run > log.txt &
  - bash <(curl -s https://raw.githubusercontent.com/s12v/wait4port/master/wait4port.sh) localhost:9911 localhost:9324
  - bundle exec cucumber
  - >
    docker run -it
    -e ENDPOINT="$ENDPOINT"
    -e AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID"
    -e AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY"
    -v "$PWD":/tmp -w /tmp --net=host php:7-alpine
    bin/behat

after_script:
  - cat db.json

after_failure:
  - cat log.txt

after_success:
  - bash <(curl -s https://codecov.io/bash)
